<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>再生</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{margin:0;background:#f5f6f8;font-family:system-ui}
.banner{display:flex;gap:6px;padding:10px;background:#fff}
.banner button{flex:1;padding:8px;border-radius:8px}
iframe{width:100%;height:240px;border:none;background:#000}
.section{background:#fff;margin:12px;padding:12px;border-radius:12px}
.related{display:flex;gap:8px;margin-top:8px;cursor:pointer}
.related img{width:120px;border-radius:8px}
.small{font-size:12px;color:#666}
</style>
</head>
<body>

<div class="banner">
  <button onclick="setPlayer('nocookie')">nocookie</button>
  <button onclick="setPlayer('education')">education</button>
  <button onclick="setPlayer('embed')">invidious</button>
</div>

<iframe id="player" allowfullscreen></iframe>

<div class="section">
  <h2 id="title">読み込み中</h2>
  <p id="desc" class="small"></p>

  <button onclick="load360()">⬇ 360p</button>
  <button onclick="loadM3U8()">⬇ m3u8</button>
  <div id="dl"></div>
</div>

<div class="section">
  <h3>関連動画</h3>
  <div id="related"></div>
</div>

<script>
const v=new URLSearchParams(location.search).get("v");
const p=document.getElementById("player");

function setPlayer(t){
  if(t==="nocookie")p.src=`https://www.youtube-nocookie.com/embed/${v}`;
  if(t==="education")p.src=`https://www.youtubeeducation.com/embed/${v}`;
  if(t==="embed")p.src=`https://pol1.iv.ggtyler.dev/embed/${v}`;
}
setPlayer("nocookie");

fetch(`/api/video/${v}`).then(r=>r.json()).then(d=>{
  title.textContent=d.title;
  desc.textContent=d.description||"";
  d.related.forEach(r=>{
    const div=document.createElement("div");
    div.className="related";
    div.onclick=()=>location.href=`watch.html?v=${r.videoId}`;
    div.innerHTML=`<img src="https://i.ytimg.com/vi/${r.videoId}/hqdefault.jpg"><div>${r.title}</div>`;
    related.appendChild(div);
  });
});

function load360(){
  fetch(`/api/download/360p/${v}`).then(r=>r.json()).then(d=>{
    dl.innerHTML=`<a href="${d.url}" target="_blank">360p ダウンロード</a>`;
  });
}
function loadM3U8(){
  fetch(`/api/download/m3u8/${v}`).then(r=>r.json()).then(d=>{
    dl.innerHTML=`<a href="${d.url}" target="_blank">m3u8 ストリーム</a>`;
  });
}
</script>

</body>
</html>
