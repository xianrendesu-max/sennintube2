<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>仙人YouTubeビュアー</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  margin: 0;
  font-family: system-ui, sans-serif;
  background: #f5f6f8;
  color: #111;
}

/* ===== レイアウト ===== */
.container {
  max-width: 960px;
  margin: auto;
  padding: 16px;
}

/* ===== 動画（16:9固定） ===== */
.video-wrap {
  position: relative;
  width: 100%;
  aspect-ratio: 16 / 9;
  background: #000;
  border-radius: 12px;
  overflow: hidden;
}

.video-wrap iframe {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  border: none;
}

/* ===== 情報 ===== */
h1 {
  font-size: 20px;
  margin: 12px 0 4px;
}

.author {
  font-size: 14px;
  color: #555;
}

/* ===== ボタン ===== */
.buttons {
  display: flex;
  gap: 8px;
  margin: 12px 0;
}

button {
  padding: 10px 14px;
  border: 1px solid #ccc;
  background: #fff;
  cursor: pointer;
  border-radius: 6px;
  font-size: 14px;
}

button.primary {
  background: #2563eb;
  color: #fff;
  border: none;
}

/* ===== DLアニメーション ===== */
#loading {
  display: none;
  margin-top: 8px;
  font-size: 13px;
  color: #555;
}

/* ===== コメント ===== */
.comments {
  margin-top: 24px;
}

.comment {
  background: #fff;
  padding: 10px;
  border-radius: 8px;
  margin-bottom: 8px;
}

.comment-author {
  font-size: 13px;
  font-weight: bold;
}
.comment-text {
  font-size: 14px;
}
</style>
</head>

<body>

<div class="container">

  <!-- 動画 -->
  <div class="video-wrap">
    <iframe id="player" allowfullscreen></iframe>
  </div>

  <!-- 情報 -->
  <h1 id="title">読み込み中...</h1>
  <div class="author" id="author"></div>

  <!-- ボタン -->
  <div class="buttons">
    <button onclick="setMode('invidious')">Invidious</button>
    <button onclick="setMode('nocookie')">NoCookie</button>
    <button class="primary" onclick="download()">⬇ ダウンロード</button>
  </div>

  <div id="loading">ダウンロードURL取得中...</div>

  <!-- コメント -->
  <div class="comments" id="comments"></div>

</div>

<script>
const params = new URLSearchParams(location.search);
const videoId = params.get("v");

let mode = "invidious";

const player = document.getElementById("player");

function setMode(m) {
  mode = m;
  loadPlayer();
}

function loadPlayer() {
  if (mode === "nocookie") {
    player.src = `https://www.youtube-nocookie.com/embed/${videoId}`;
  } else {
    player.src = `https://invidious.0011.lt/embed/${videoId}`;
  }
}

/* ===== 動画情報 ===== */
fetch(`/api/video?video_id=${videoId}`)
  .then(r => r.json())
  .then(d => {
    document.getElementById("title").textContent = d.video.title;
    document.getElementById("author").textContent = d.video.author;
  });

/* ===== コメント ===== */
fetch(`/api/comments?video_id=${videoId}`)
  .then(r => r.json())
  .then(d => {
    const box = document.getElementById("comments");
    d.comments.forEach(c => {
      const div = document.createElement("div");
      div.className = "comment";
      div.innerHTML = `
        <div class="comment-author">${c.author}</div>
        <div class="comment-text">${c.content}</div>
      `;
      box.appendChild(div);
    });
  });

/* ===== ダウンロード（重要） ===== */
function download() {
  document.getElementById("loading").style.display = "block";

  // ★ fetchしない！直接遷移！
  window.location.href = `/api/download?video_id=${videoId}`;

  setTimeout(() => {
    document.getElementById("loading").style.display = "none";
  }, 4000);
}

loadPlayer();
</script>

</body>
    </html>
