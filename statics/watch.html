<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>再生 | 仙人YouTubeビュアー</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  margin:0;
  font-family:system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background:#000;
  color:#fff;
}
video{
  width:100%;
  background:#000;
}
section{
  padding:12px;
}
button{
  padding:8px 12px;
  border-radius:8px;
  border:none;
  background:#ef4444;
  color:#fff;
  margin:4px 4px 4px 0;
  cursor:pointer;
}
.card{
  background:#111;
  padding:8px;
  margin:6px 0;
  border-radius:8px;
  cursor:pointer;
}
.card:hover{
  background:#1a1a1a;
}

/* ===== DL オーバーレイ ===== */
#dlOverlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.75);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
}
#dlBox{
  background:#111;
  padding:24px;
  border-radius:16px;
  text-align:center;
  width:240px;
}
.spinner{
  width:48px;
  height:48px;
  border:5px solid #333;
  border-top:5px solid #ef4444;
  border-radius:50%;
  animation:spin 1s linear infinite;
  margin:0 auto 16px;
}
@keyframes spin{
  to{transform:rotate(360deg)}
}
#dlText{
  font-size:14px;
  color:#ddd;
}
</style>
</head>

<body>

<video id="player" controls></video>

<section>
  <button onclick="setMode('inv')">Invidious</button>
  <button onclick="setMode('noc')">NoCookie</button>
  <button onclick="setMode('edu')">Education</button>
  <br>
  <button onclick="download('18')">⬇ 360p</button>
  <button onclick="download('22')">⬇ HD</button>
</section>

<section id="info"></section>
<section id="related"></section>
<section id="comments"></section>

<!-- DL Overlay -->
<div id="dlOverlay">
  <div id="dlBox">
    <div class="spinner"></div>
    <div id="dlText">ダウンロード準備中…</div>
  </div>
</div>

<script>
const params = new URLSearchParams(location.search);
const vid = params.get("v");
const player = document.getElementById("player");
let mode = "inv";

function setMode(m){
  mode = m;
  loadVideo();
}

async function loadVideo(){
  if(mode==="noc"){
    player.src = `https://www.youtube-nocookie.com/embed/${vid}`;
    return;
  }
  if(mode==="edu"){
    player.src = `https://www.youtubeeducation.com/embed/${vid}`;
    return;
  }

  const r = await fetch(`/api/video/${vid}`);
  const d = await r.json();
  const v = d.video;

  const mp4 = v.formatStreams?.find(f=>f.itag==="18");
  if(mp4) player.src = mp4.url;

  info.innerHTML = `
    <h3>${v.title}</h3>
    <p>${v.author} / ${v.viewCount?.toLocaleString()} 回再生</p>
  `;

  related.innerHTML = "<h4>関連動画</h4>";
  d.related.forEach(rv=>{
    const div=document.createElement("div");
    div.className="card";
    div.textContent=rv.title;
    div.onclick=()=>location.href=`watch.html?v=${rv.videoId}`;
    related.appendChild(div);
  });

  loadComments();
}

async function loadComments(){
  const r = await fetch(`/api/comments/${vid}`);
  const d = await r.json();
  comments.innerHTML = "<h4>コメント</h4>";
  d.comments?.forEach(c=>{
    const div=document.createElement("div");
    div.className="card";
    div.innerHTML = `<b>${c.author}</b><br>${c.contentHtml}`;
    comments.appendChild(div);
  });
}

/* ===== ダウンロード（アニメーション付き） ===== */
function download(itag){
  const overlay = document.getElementById("dlOverlay");
  const text = document.getElementById("dlText");

  overlay.style.display = "flex";
  text.textContent = "ダウンロード開始中…";

  // 少し待ってから遷移（UX向上）
  setTimeout(()=>{
    window.location.href = `/api/download/${vid}?itag=${itag}`;

    // 数秒後に非表示（DLが始まるため）
    setTimeout(()=>{
      overlay.style.display = "none";
    }, 3000);

  }, 400);
}

loadVideo();
</script>

</body>
</html>
